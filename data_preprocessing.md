# 高頻電力數據預處理流程設計

## 1. 數據清洗流程

### 1.1 缺失值處理
- **檢測方法**：
  - 時間戳檢查：確保每5秒都有對應數據點
  - 數值檢查：識別空值或異常值（如0、負值或極端值）
- **處理策略**：
  - **短時間缺失**（<1分鐘）：
    - 線性插值：適用於平穩期間的短時間缺失
    - 樣條插值：適用於變化較大期間的缺失
  - **中等時間缺失**（1分鐘-1小時）：
    - 使用相似時段歷史數據填充（如前一天同時段）
    - 使用移動平均或中位數填充
  - **長時間缺失**（>1小時）：
    - 標記為特殊事件，可能需要從分析中排除
    - 使用機器學習模型預測缺失區間（如KNN或隨機森林）
- **實施步驟**：
  1. 建立完整時間索引（每5秒一個點）
  2. 將原始數據與完整時間索引對齊，識別缺失點
  3. 根據缺失持續時間應用不同策略
  4. 記錄所有缺失區間，用於後續分析

### 1.2 異常值處理
- **檢測方法**：
  - 統計閾值：基於均值±3倍標準差
  - IQR方法：識別超出1.5×IQR範圍的值
  - 基於時間窗口的Z-score
  - 孤立森林或One-Class SVM等無監督學習方法
- **處理策略**：
  - **輕微異常**：
    - 使用移動中位數替換
    - 使用前後數據點的平均值替換
  - **嚴重異常**：
    - 標記為特殊事件
    - 使用相似時段的歷史數據替換
    - 可選擇保留異常，但在模型中加入異常標記特徵
- **實施步驟**：
  1. 對每個測量指標（電壓、電流、功率等）分別進行異常檢測
  2. 考慮時間上下文（工作時間vs非工作時間）設定動態閾值
  3. 區分系統異常和真實用電異常
  4. 記錄所有異常點，用於後續分析

### 1.3 噪聲過濾
- **檢測方法**：
  - 頻譜分析：識別高頻噪聲
  - 移動標準差：識別波動異常區間
- **處理策略**：
  - 移動平均濾波：簡單有效的噪聲減少方法
  - Savitzky-Golay濾波：保留峰值特性的平滑方法
  - 小波變換：多尺度噪聲過濾
- **實施步驟**：
  1. 評估原始數據的噪聲水平
  2. 選擇適當的濾波方法和參數
  3. 應用濾波並評估結果
  4. 保存原始數據和過濾後數據，以便比較

### 1.4 數據一致性檢查
- **檢測方法**：
  - 物理規則檢查：如功率=電壓×電流
  - 累計值檢查：確保累計用電量單調增加
  - 跨指標相關性檢查
- **處理策略**：
  - 修正不一致數據：基於物理規則
  - 標記不可修正的不一致
  - 必要時排除不一致數據點
- **實施步驟**：
  1. 定義數據一致性規則
  2. 自動檢測違反規則的數據點
  3. 應用修正策略
  4. 記錄所有修正操作

## 2. 特徵工程流程

### 2.1 時間特徵提取
- **基本時間特徵**：
  - 小時（0-23）
  - 星期幾（0-6）
  - 月份（1-12）
  - 季節（春夏秋冬）
  - 是否工作日
  - 是否假日
- **循環時間特徵**：
  - 小時的正弦和餘弦轉換
  - 星期的正弦和餘弦轉換
  - 月份的正弦和餘弦轉換
- **特殊時間段標記**：
  - 工作時間（如9:00-18:00）
  - 午休時間（如12:00-13:00）
  - 下班後時間
  - 週末時間
- **實施步驟**：
  1. 從時間戳提取基本時間特徵
  2. 創建循環特徵以捕捉週期性
  3. 根據辦公室運作時間定義特殊時間段
  4. 整合假日日曆數據

### 2.2 滯後特徵創建
- **短期滯後特徵**：
  - 前1分鐘、5分鐘、15分鐘、30分鐘的用電量
  - 前1小時、2小時、3小時的用電量
- **長期滯後特徵**：
  - 前1天同時段的用電量
  - 前1週同時段的用電量
  - 前1個月同時段的用電量
- **統計滯後特徵**：
  - 過去1小時的平均用電量
  - 過去1天的平均用電量
  - 過去1週同時段的平均用電量
- **實施步驟**：
  1. 根據預測目標（短期、中期、長期）選擇適當的滯後特徵
  2. 創建滯後特徵矩陣
  3. 處理滯後特徵中的缺失值

### 2.3 統計特徵計算
- **窗口統計特徵**：
  - 移動平均（不同窗口大小）
  - 移動標準差
  - 移動最大值和最小值
  - 移動中位數
  - 移動四分位數
- **趨勢特徵**：
  - 簡單移動平均差異
  - 指數加權移動平均
  - 線性回歸斜率（短時間窗口內）
- **波動特徵**：
  - 變異係數
  - 峰度和偏度
  - 最大波動幅度
- **實施步驟**：
  1. 定義不同時間窗口（如5分鐘、15分鐘、1小時等）
  2. 計算每個窗口的統計特徵
  3. 評估特徵重要性，選擇最相關特徵

### 2.4 外部特徵整合
- **天氣特徵**：
  - 溫度（當前和預測）
  - 濕度
  - 天氣狀況（晴、陰、雨等）
  - 日照時間
- **辦公室使用情況**：
  - 辦公室占用率
  - 特殊活動或會議
  - 設備維護時間
- **能源價格**：
  - 電價（如果有分時電價）
  - 電價變動預告
- **實施步驟**：
  1. 建立外部數據API連接
  2. 同步外部數據時間戳與電力數據
  3. 處理外部數據中的缺失值
  4. 評估外部特徵與用電量的相關性

## 3. 數據降採樣策略

### 3.1 時間降採樣
- **降採樣方法**：
  - 平均值聚合：計算時間窗口內的平均值
  - 中位數聚合：減少異常值影響
  - 最大值聚合：捕捉峰值用電
  - 積分聚合：計算總用電量
- **多尺度降採樣**：
  - 短期預測：5秒→1分鐘或5分鐘
  - 中期預測：5秒→15分鐘或1小時
  - 長期預測：5秒→1小時或1天
- **實施步驟**：
  1. 根據預測目標確定降採樣尺度
  2. 選擇適當的聚合方法
  3. 執行降採樣並驗證結果
  4. 保存多尺度數據集

### 3.2 特徵降維
- **降維方法**：
  - 主成分分析(PCA)
  - 因子分析
  - 自編碼器
  - 特徵選擇（基於相關性或重要性）
- **應用場景**：
  - 高維特徵集（多種測量+多種衍生特徵）
  - 多變量預測模型
  - 深度學習模型的預處理
- **實施步驟**：
  1. 標準化特徵
  2. 應用降維方法
  3. 評估降維結果
  4. 選擇最佳降維參數

## 4. 數據標準化/正規化方法

### 4.1 標準化方法
- **Z-score標準化**：
  - 轉換為均值0、標準差1的分布
  - 適用於大多數機器學習算法
  - 對異常值敏感
- **Min-Max正規化**：
  - 縮放到[0,1]或[-1,1]範圍
  - 保留原始分布形狀
  - 適用於需要有界輸入的模型（如神經網絡）
- **Robust標準化**：
  - 基於中位數和四分位距
  - 對異常值不敏感
  - 適用於有異常值的數據
- **實施步驟**：
  1. 根據模型需求選擇標準化方法
  2. 對訓練數據擬合標準化器
  3. 轉換訓練和測試數據
  4. 保存標準化參數用於未來數據

### 4.2 時間序列特定標準化
- **滑動窗口標準化**：
  - 使用局部時間窗口進行標準化
  - 適應時間序列的非平穩性
  - 適用於有季節性或趨勢的數據
- **差分變換**：
  - 一階差分：消除趨勢
  - 季節性差分：消除季節性
  - 適用於ARIMA類模型
- **對數變換**：
  - 穩定方差
  - 減少極端值影響
  - 適用於呈指數增長的數據
- **實施步驟**：
  1. 分析時間序列的平穩性
  2. 選擇適當的變換方法
  3. 應用變換並檢查結果
  4. 記錄逆變換方法用於還原預測值

## 5. 時間特徵提取方法

### 5.1 頻域特徵提取
- **傅立葉變換**：
  - 識別主要頻率成分
  - 提取週期性模式
  - 適用於有明顯週期的數據
- **小波變換**：
  - 多尺度頻率分析
  - 同時捕捉時間和頻率信息
  - 適用於非平穩時間序列
- **實施步驟**：
  1. 對原始或預處理後的數據應用變換
  2. 提取主要頻率成分
  3. 創建基於頻率的特徵
  4. 評估頻域特徵的預測價值

### 5.2 時間序列分解
- **經典分解**：
  - 分解為趨勢、季節性和殘差成分
  - 簡單直觀
  - 適用於有明顯季節性的數據
- **STL分解**：
  - 季節性趨勢分解（使用LOESS）
  - 處理複雜季節性
  - 對異常值較為穩健
- **MSTL分解**：
  - 多季節性時間序列分解
  - 處理多重季節性（如日、週、月）
  - 適用於高頻電力數據
- **實施步驟**：
  1. 選擇適當的分解方法
  2. 確定季節性週期長度
  3. 執行分解
  4. 使用分解成分作為特徵或單獨建模

## 6. 預處理流程整合

### 6.1 流程架構
1. **數據收集層**：
   - 從電錶獲取原始5秒數據
   - 初步數據驗證
   - 數據存儲

2. **數據清洗層**：
   - 缺失值處理
   - 異常值處理
   - 噪聲過濾
   - 一致性檢查

3. **特徵工程層**：
   - 時間特徵提取
   - 滯後特徵創建
   - 統計特徵計算
   - 外部特徵整合

4. **數據轉換層**：
   - 時間降採樣
   - 特徵降維
   - 數據標準化
   - 時間序列分解

5. **數據分割層**：
   - 訓練/驗證/測試集分割
   - 時間序列交叉驗證準備

### 6.2 多尺度預處理流程
- **原始數據層**（5秒）：
  - 完整清洗和驗證
  - 異常檢測
  - 基本統計特徵

- **分鐘級數據層**（1-5分鐘）：
  - 短期預測準備
  - 詳細時間特徵
  - 短期滯後特徵

- **小時級數據層**：
  - 中期預測準備
  - 日內模式特徵
  - 中期滯後特徵

- **日級數據層**：
  - 長期預測準備
  - 週/月模式特徵
  - 長期滯後特徵

### 6.3 預處理流程自動化
- **流程編排**：
  - 使用Airflow或類似工具
  - 定義任務依賴關係
  - 設置執行排程

- **監控與警報**：
  - 數據質量監控
  - 處理失敗警報
  - 性能指標追蹤

- **版本控制**：
  - 預處理參數版本控制
  - 特徵定義版本控制
  - 處理結果版本控制

### 6.4 預處理結果評估
- **數據質量指標**：
  - 缺失值比例
  - 異常值比例
  - 數據完整性得分

- **特徵質量指標**：
  - 特徵-目標相關性
  - 特徵重要性評估
  - 特徵冗餘度分析

- **預處理效果評估**：
  - 預處理前後模型性能比較
  - 計算效率評估
  - 存儲需求評估

## 7. 實施計劃

### 7.1 開發階段
1. **原型開發**：
   - 實現基本清洗和特徵工程
   - 使用小型數據集測試
   - 評估初步結果

2. **擴展開發**：
   - 實現完整預處理流程
   - 整合外部數據源
   - 優化計算效率

3. **生產準備**：
   - 代碼重構和優化
   - 完整文檔編寫
   - 單元測試和集成測試

### 7.2 技術選擇
- **編程語言**：Python
- **主要庫**：
  - 數據處理：Pandas, NumPy
  - 時間序列：statsmodels, Prophet
  - 機器學習：scikit-learn
  - 深度學習：TensorFlow/Keras, PyTorch
  - 數據存儲：SQLite/PostgreSQL, InfluxDB
- **開發環境**：Jupyter Notebook, VS Code

### 7.3 資源需求
- **計算資源**：
  - 開發階段：標準開發機器
  - 生產階段：根據數據量和模型複雜度確定
- **存儲資源**：
  - 原始數據：~620MB/年
  - 處理後數據：~1-2GB/年
  - 模型和參數：~100MB

### 7.4 時間規劃
- **原型階段**：2-3週
- **擴展階段**：4-6週
- **生產準備**：2-4週
- **總計**：8-13週（視需求複雜度而定）
